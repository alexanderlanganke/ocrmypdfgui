name: ocrmypdfgui # you probably want to 'snapcraft register <name>'
title: ocrmypdfgui
base: core20 # the base snap is the execution environment for this snap
version: '0.9.08' # just for humans, typically '1.2+git' or '1.3.2'
summary: Hobby Project GUI for the Python Program "OCRmyPDF" by James R. Barlow
description: |
  I use James R. Barlow's OCRmyPDF heavily in my paperless Office and have created this Python Project as a GUI wrapper to run batch jobs on my filesystem. This is strictly a Hobby Project and is not "official". Feel free to use it if you like. Includes full current version of OCRmyPDF as backend. Icons and banner made by Freepik from www.flaticon.com
icon: gui/ocrmypdfgui.png
grade: stable # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots
#
architectures: [amd64]

environment:
    TESSDATA_PREFIX: $SNAP/usr/share/tesseract-ocr/4.00/tessdata
    GS_LIB: $SNAP/usr/share/ghostscript/9.50/Resource/Init
    GS_FONTPATH: $SNAP/usr/share/ghostscript/9.50/Resource/Font
    LD_LIBRARY_PATH: $SNAP/usr/lib/x86_64-linux-gnu

apps:
  ocrmypdfgui:
#    command: bin/snapcraft-preload python3 $SNAP/lib/python3.6/site-packages/ocrmypdfgui/__main__.py
#    command: usr/bin/snapcraft-preload bin/python3.9 -m ocrmypdfgui
    command: bin/python3.9 -m ocrmypdfgui

    desktop: $SNAPCRAFT_PROJECT_DIR/gui/ocrmypdfgui.desktop
    extensions: [gnome-3-38]

    plugs:
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - home
      - removable-media


parts:
  snapcraft-preload:
    source: https://github.com/sergiusens/snapcraft-preload.git
    plugin: cmake
    cmake-parameters:
      - -DCMAKE_INSTALL_PREFIX=/usr -DLIBPATH=/usr/lib
    build-packages:
      - on amd64:
        - gcc-multilib
        - g++-multilib
    stage-packages:
      - lib32stdc++6

  ocrmypdfgui:
    # See 'snapcraft plugins'
    plugin: python
    source: .

    build-environment:
      - SNAPCRAFT_PYTHON_INTERPRETER: python3.9
        # python3.9 lives in $SNAPCRAFT_PART_INSTALL/bin
      - PATH: $SNAPCRAFT_PART_INSTALL/bin:$PATH
      - PYTHONPATH: ''

    build-packages:
      - python3.9-venv
      - python3.9-dev

  #  override-build: |
  #    rm -rf $SNAPCRAFT_PART_INSTALL/usr/lib/python3.9/distutils
  #    cp -r /usr/lib/python3.9/distutils $SNAPCRAFT_PART_INSTALL/usr/lib/python3.9/distutils
  #    mkdir -p $SNAPCRAFT_PART_INSTALL/usr/include/
  #    cp -r /usr/include/python3.9 $SNAPCRAFT_PART_INSTALL/usr/include/python3.9
  #    snapcraftctl build

  #  stage-packages:
  #    - python3.9-venv

  ocrmypdf:
    # See 'snapcraft plugins'
    plugin: python
    source: https://github.com/ocrmypdf/OCRmyPDF.git

  #  build-environment:
  #    - SNAPCRAFT_PYTHON_INTERPRETER: python3.9
        # python3.9 lives in $SNAPCRAFT_PART_INSTALL/bin
  #    - PATH: $SNAPCRAFT_PART_INSTALL/bin:$PATH
  #    - PYTHONPATH: ''

  #  build-packages:
  #    - python3.9-venv
  #    - python3.9-dev

    stage-packages:
      #- python3.9-venv
      - ghostscript
      - icc-profiles-free
      - liblept5
      - libxml2
      - pngquant
      - tesseract-ocr-all
      - unpaper
      - qpdf
      - zlib1g

    python-packages:
      - cffi  # must be a setup and install requirement
      - pdfminer.six
      - pikepdf
      - Pillow
      - pluggy
      - reportlab
      - setuptools
      - tqdm
      - pipe

    override-build: |
      ln -sf ../usr/lib/libsnapcraft-preload.so $SNAPCRAFT_PART_INSTALL/lib/libsnapcraft-preload.so
      rm -rf $SNAPCRAFT_PART_INSTALL/usr/lib/python3.9/distutils
      cp -r /usr/lib/python3.9/distutils $SNAPCRAFT_PART_INSTALL/usr/lib/python3.9/distutils
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/include/
      cp -r /usr/include/python3.9 $SNAPCRAFT_PART_INSTALL/usr/include/python3.9
      snapcraftctl build
