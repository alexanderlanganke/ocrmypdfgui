name: ocrmypdfgui # you probably want to 'snapcraft register <name>'
title: ocrmypdfgui
base: core18 # the base snap is the execution environment for this snap
version: '0.9.03' # just for humans, typically '1.2+git' or '1.3.2'
summary: Hobby Project GUI for the Python Program "OCRmyPDF" by James R. Barlow
description: |
  I use James R. Barlow's OCRmyPDF heavily in my paperless Office and have created this Python Project as a GUI wrapper to run batch jobs on my filesystem. This is strictly a Hobby Project and is not "official". Feel free to use it if you like. Includes full current version of OCRmyPDF as backend. Icons and banner made by Freepik from www.flaticon.com
icon: gui/ocrmypdfgui.png
grade: devel # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots

architectures: [amd64]

plugs:
  gnome-3-32-1804:
    interface: content
    target: $SNAP/gnome-platform
    default-provider: gnome-3-32-1804

apps:
  ocrmypdfgui:
    #command: bin/snapcraft-preload python3 $SNAP/lib/python3.6/site-packages/ocrmypdfgui/__main__.py
    #command: python3 $SNAP/lib/python3.6/site-packages/ocrmypdfgui/__main__.py
    command: bin/desktop-launch $SNAP/lib/python3.6/site-packages/ocrmypdfgui/__main__.py
    #command-chain: [bin/debian-multiarch-triplet-provider-launch, bin/tcltk-launch]
    desktop: $SNAPCRAFT_PROJECT_DIR/gui/ocrmypdfgui.desktop
    extensions: [gnome-3-34]

    plugs:
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - home
      - removable-media

    environment:
       TESSDATA_PREFIX: $SNAP/usr/share/tesseract-ocr/4.00/tessdata
       GS_LIB: $SNAP/usr/share/ghostscript/9.26/Resource/Init
       GS_FONTPATH: $SNAP/usr/share/ghostscript/9.26/Resource/Font
       LD_LIBRARY_PATH: $SNAP/usr/lib/x86_64-linux-gnu
       PYTHONPATH: $PYTHONPATH:$SNAP_DESKTOP_RUNTIME/usr/lib/python3.6/site-packages:$SNAP/usr/lib/python3.6/site-packages:$SNAP/lib/python3.6/site-packages


parts:
  desktop-gnome-platform:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-depth: 1
    source-subdir: gtk
    plugin: make
    make-parameters: [ "FLAVOR=gtk3" ]
    build-environment: &buildenv
      - PATH: /snap/gnome-3-32-1804-sdk/current/usr/bin:$PATH
      - XDG_DATA_DIRS: /snap/gnome-3-32-1804-sdk/current/usr/share:/usr/share:$XDG_DATA_DIRS
      - LD_LIBRARY_PATH: /snap/gnome-3-32-1804-sdk/current/lib/$SNAPCRAFT_ARCH_TRIPLET:/snap/gnome-3-32-1804-sdk/current/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:/snap/gnome-3-32-1804-sdk/current/usr/lib:/snap/gnome-3-32-1804-sdk/current/usr/lib/vala-current:$LD_LIBRARY_PATH
      - PKG_CONFIG_PATH: /snap/gnome-3-32-1804-sdk/current/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pkgconfig:/snap/gnome-3-32-1804-sdk/current/usr/lib/pkgconfig:/snap/gnome-3-32-1804-sdk/current/usr/share/pkgconfig:$PKG_CONFIG_PATH
      - GETTEXTDATADIRS: /snap/gnome-3-32-1804-sdk/current/usr/share/gettext-current:$GETTEXTDATADIRS
      - GDK_PIXBUF_MODULE_FILE: /snap/gnome-3-32-1804-sdk/current/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/gdk-pixbuf-current/loaders.cache
    build-snaps: [ gnome-3-32-1804-sdk ]
    override-build: |
      snapcraftctl build
      mkdir -pv $SNAPCRAFT_PART_INSTALL/gnome-platform

  ocrmypdfgui:
    # See 'snapcraft plugins'
    after:[desktop-gnome-platform]
    plugin: python
    source: .
    stage-packages: [ghostscript, icc-profiles-free, liblept5, libxml2, pngquant, tesseract-ocr-all, unpaper, qpdf, zlib1g]

    python-packages:
      - ocrmypdf
      - cffi  # must be a setup and install requirement
      - coloredlogs # strictly optional
      - img2pdf  # pure Python, so track HEAD closely
      - pdfminer.six
      - pikepdf
      - Pillow
      - pluggy
      - reportlab
      - setuptools
      - tqdm
      - pycairo
      - PyGObject

    override-build: |
      snapcraftctl build
      sed -i 's/find_library(libname)/"liblept.so.5"/g' $SNAPCRAFT_PART_INSTALL/lib/python3.6/site-packages/ocrmypdf/leptonica.py
